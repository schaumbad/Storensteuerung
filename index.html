<!DOCTYPE html>
<html>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>

html { 
  font-family: 'Arial';
}

h1 {
  margin-bottom: 5px;
}

button {
  height: 100px; width:100px;
  border-radius: 10px;
  margin-bottom: 10px;
  margin-right:  5px;
  padding:       15px;
  user-select: none;
  border: 3px outset gray;
  stroke: gray;
}
button:active {
  background-color: lightgreen;
  border: 3px inset gray;
  transform: translateY(5px);
  stroke: green;
}
button.busy {
  border: 3px outset cyan;
  stroke: darkcyan;
}
button.busy:active {
  border: 3px inset cyan;
}

.down svg {
  transform: scale(1,-1);
}

div.group {
  margin-top:  20px;
  margin-left: 20px;
}
</style>

<body onload="init()">

<div class="group">
<h1>Nord</h1>
<div>
<button onclick="sendLong (event, relayNordAuf,relayNordAb)">
  <svg viewBox="-10 -10 20 20"><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(event, relayNordAuf,relayNordAb)">
  <svg viewBox="-10 -10 20 20"><use href="#shortArrow"/></svg>
</button>
</div>
<div class="down">
<button onclick="sendLong (event, relayNordAb,relayNordAuf)">
  <svg viewBox="-10 -10 20 20"><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(event, relayNordAb,relayNordAuf)">
  <svg viewBox="-10 -10 20 20"><use href="#shortArrow"/></svg>
</button>
</div>
</div>

<div class="group">
<h1>SÃ¼d</h1>
<div>
<button onclick="sendLong (event, relaySuedAuf,relaySuedAb)">
  <svg viewBox="-10 -10 20 20"><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(event, relaySuedAuf,relaySuedAb)">
  <svg viewBox="-10 -10 20 20"><use href="#shortArrow"/></svg>
</button>
</div>
<div class="down">
<button onclick="sendLong (event, relaySuedAb,relaySuedAuf)">
  <svg viewBox="-10 -10 20 20"><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(event, relaySuedAb,relaySuedAuf)">
  <svg viewBox="-10 -10 20 20"><use href="#shortArrow"/></svg>
</button>
</div>
</div>


<script>
const shellyNord = "http://192.168.0.23"
const shellySued = "http://192.168.0.24"

const relaySuedAuf = shellySued + "/relay/0"
const relaySuedAb  = shellySued + "/relay/1"
const relayNordAuf = shellyNord + "/relay/0"
const relayNordAb  = shellyNord + "/relay/1"

function sendOff(relay)     { return fetch(relay + "?turn=off"); }
function sendOnLong(relay)  { return fetch(relay + "?turn=on&timer=2"); }
function sendOnShort(relay) { return fetch(relay + "?turn=on&timer=1"); }

var lastPromise = 0;

function init() {
  lastPromise = Promise.all([
    fetch(shellyNord + "/status"),
    fetch(shellySued + "/status")
  ]);
  lastPromise.catch(failureCallback);
}

function toggleBusyState(element) {
  var attr = element.getAttributeNode("busyCount");
  if (!attr) {
    attr = document.createAttribute("busyCount");
    attr.value = 0;
    element.setAttributeNode(attr);
  }
  element.classList.add("busy");
  attr.value = parseInt(attr.value) + 1;
  return ()=>{
    var num = parseInt(attr.value) - 1;
    attr.value = num;
    if (!num) {
      element.classList.remove("busy");
    }
  };
}


function sendLong(event, relay, opposite) {
  var toggle = toggleBusyState(event.currentTarget);
  navigator.vibrate(400);
  lastPromise = lastPromise
    .then(response => sendOff(opposite))
    .then(response => sendOff(relay))
    .then(response => sendOnLong(relay))
    .catch(failureCallback)
    .finally(toggle);
}

function sendShort(event, relay, opposite) {
  var toggle = toggleBusyState(event.currentTarget);
  navigator.vibrate(200);
  lastPromise = lastPromise
    .then(response => sendOff(opposite))
    .then(response => sendOff(relay))
    .then(response => Promise.all([sendOnShort(relay), createWait(200)]))
    .then(response => sendOff(relay))
    .catch(failureCallback)
    .finally(toggle);
}

function createWait(milliseconds) {
  return new Promise((resolve, reject) => {
    setTimeout(() => { resolve(); }, milliseconds);
  });
}

function failureCallback(err) {
  console.log(err);
}


(function() {
  document.querySelectorAll("button").forEach(
    (i)=>{ i.addEventListener("touchend" , onTouchend); });
})();

function onTouchend(event) {
  if (event.currentTarget.matches("button:active")) {
    event.currentTarget.click();
    event.preventDefault();
  }
}


</script>

<svg style="display:none" viewBox="-10 -10 20 20">
  <path id="arrow" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
    d="M0 -8 v16 M0 -8 m-6 6 l6 -6 l6 6"/>
  <path id="shortArrow" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
    d="M0 -8     M0 -8 m-6 6 l6 -6 l6 6"/>
</svg>

</body>
</html>
