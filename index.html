<!DOCTYPE html>
<html>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>

html { 
  font-family: 'Arial';
}

h1 {
  margin-bottom: 5px;
  margin-top:    5px;
}

button {
  height: 80px; width: 80px;
  border-radius: 10px;
  margin-bottom: 10px;
  margin-right:  20px;
  padding:       15px;
  user-select: none;
  border: 3px outset gray;
  stroke: gray;
}
button:active {
  background-color: lightgreen;
  border: 3px inset gray;
  transform: translateY(5px);
  stroke: green;
}
button.busy {
  border: 3px outset cyan;
  stroke: darkcyan;
}
button.busy:active {
  border: 3px inset cyan;
}

.down svg {
  transform: scale(1,-1);
}
svg {
  width:  100%;
  height: 100%;
}

div.group {
  margin-top:  10px;
  margin-left: 20px;
}

</style>

<body onload="init()">

<div class="group">
<h1>Wohnzimmer</h1>
<div>
<button onclick="sendLong (lastPromiseNord, event, relayNordAuf,relayNordAb)">
  <svg><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(lastPromiseNord, event, relayNordAuf,relayNordAb)">
  <svg><use href="#shortArrow"/></svg>
</button>
</div>
<div class="down">
<button onclick="sendLong (lastPromiseNord, event, relayNordAb,relayNordAuf)">
  <svg><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(lastPromiseNord, event, relayNordAb,relayNordAuf)">
  <svg><use href="#shortArrow"/></svg>
</button>
</div>
</div>

<div class="group">
<h1>Adi</h1>
<div>
<button onclick="sendLong (lastPromiseSued, event, relaySuedAuf,relaySuedAb)">
  <svg><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(lastPromiseSued, event, relaySuedAuf,relaySuedAb)">
  <svg><use href="#shortArrow"/></svg>
</button>
</div>
<div class="down">
<button onclick="sendLong (lastPromiseSued, event, relaySuedAb,relaySuedAuf)">
  <svg><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(lastPromiseSued, event, relaySuedAb,relaySuedAuf)">
  <svg><use href="#shortArrow"/></svg>
</button>
</div>
</div>

<div class="group">
<h1>Beide</h1>
<div>
<button onclick="sendLong (lastPromiseNord, event, relayNordAuf,relayNordAb);
                 sendLong (lastPromiseSued, event, relaySuedAuf,relaySuedAb)">
  <svg><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(lastPromiseNord, event, relayNordAuf,relayNordAb);
                 sendShort(lastPromiseSued, event, relaySuedAuf,relaySuedAb)">
  <svg><use href="#shortArrow"/></svg>
</button>
</div>
<div class="down">
<button onclick="sendLong (lastPromiseNord, event, relayNordAb,relayNordAuf);
                 sendLong (lastPromiseSued, event, relaySuedAb,relaySuedAuf)">
  <svg><use href="#arrow"/></svg>
</button>
<button onclick="sendShort(lastPromiseNord, event, relayNordAb,relayNordAuf);
                 sendShort(lastPromiseSued, event, relaySuedAb,relaySuedAuf)">
  <svg><use href="#shortArrow"/></svg>
</button>
</div>
</div>

<script>
const shellyNord = "http://192.168.0.23"
const shellySued = "http://192.168.0.24"

const relaySuedAuf = shellySued + "/relay/0"
const relaySuedAb  = shellySued + "/relay/1"
const relayNordAuf = shellyNord + "/relay/0"
const relayNordAb  = shellyNord + "/relay/1"

function sendOff(relay)     { return fetch(relay + "?turn=off"); }
function sendOnLong(relay)  { return fetch(relay + "?turn=on&timer=2"); }
function sendOnShort(relay) { return fetch(relay + "?turn=on&timer=1"); }

var lastPromiseNord = 0;
var lastPromiseSued = 0;

function init() {
  lastPromiseNord = fetch(shellyNord + "/status");
  lastPromiseSued = fetch(shellySued + "/status");
  lastPromiseNord.catch(failureCallback);
  lastPromiseSued.catch(failureCallback);
}

function toggleBusyState(element) {
  var attr = element.getAttributeNode("busyCount");
  if (!attr) {
    attr = document.createAttribute("busyCount");
    attr.value = 0;
    element.setAttributeNode(attr);
  }
  element.classList.add("busy");
  attr.value = parseInt(attr.value) + 1;
  return ()=>{
    var num = parseInt(attr.value) - 1;
    attr.value = num;
    if (!num) {
      element.classList.remove("busy");
    }
  };
}


function sendLong(lastPromise, event, relay, opposite) {
  var toggle = toggleBusyState(event.currentTarget);
  navigator.vibrate(400);
  lastPromise = lastPromise
    .then(response => sendOff(opposite))
    .then(response => sendOff(relay))
    .then(response => sendOnLong(relay))
    .catch(failureCallback)
    .finally(toggle);
}

function sendShort(lastPromise, event, relay, opposite) {
  var toggle = toggleBusyState(event.currentTarget);
  navigator.vibrate(200);
  lastPromise = lastPromise
    .then(response => sendOff(opposite))
    .then(response => sendOff(relay))
    .then(response => Promise.all([sendOnShort(relay), createWait(200)]))
    .then(response => sendOff(relay))
    .catch(failureCallback)
    .finally(toggle);
}

function createWait(milliseconds) {
  return new Promise((resolve, reject) => {
    setTimeout(() => { resolve(); }, milliseconds);
  });
}

function failureCallback(err) {
  console.log(err);
}


(function() {
  document.querySelectorAll("button").forEach(
    (i)=>{ i.addEventListener("touchend" , onTouchend); });
})();

function onTouchend(event) {
  if (event.currentTarget.matches("button:active")) {
    event.currentTarget.click();
    event.preventDefault();
  }
}


</script>
<span style="display:none">

<svg id="arrow" viewBox="-10 -2 20 20">
  <path fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
    d="m-6 6 l6 -6 l6 6 M0 0 v16"/>
</svg>

<svg id="shortArrow" viewBox="-10 -2 20 20">
  <path fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
    d="m-6 6 l6 -6 l6 6"/>
</svg>

</span>
</body>
</html>
