<!DOCTYPE html>
<html>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>

html { 
  font-family: 'Arial';
}

h1 {
  margin-bottom: 5px;
}

button {
  height: 100px; width:100px;
  border-radius: 10px;
  margin-bottom: 10px;
  margin-right:  5px;
  user-select: none;
  border: 3px outset gray;
}
button:active {
  background-color: lightgreen;
  border: 3px inset gray;
  transform: translateY(5px);
}
button.busy {
  border: 3px outset cyan;
}
button.busy:active {
  border: 3px inset cyan;
}


div.group {
  margin-top:  20px;
  margin-left: 20px;
}
</style>

<body onload="init()">

<div class="group">
<h1>Nord</h1>
<div>
<button onclick="sendLong (event, relayNordAuf,relayNordAb)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use href="#arrow"/></svg>
<button onclick="sendShort(event, relayNordAuf,relayNordAb)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use href="#shortArrow"/></svg>
</div>
<div>
<button onclick="sendLong (event, relayNordAb,relayNordAuf)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use transform="scale(1,-1) translate(0,-24)" href="#arrow"/></svg>
<button onclick="sendShort(event, relayNordAb,relayNordAuf)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use transform="scale(1,-1) translate(0,-24)" href="#shortArrow"/></svg>
</div>
</div>

<div class="group">
<h1>SÃ¼d</h1>
<div>
<button onclick="sendLong (event, relaySuedAuf,relaySuedAb)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use href="#arrow"/></svg>
<button onclick="sendShort(event, relaySuedAuf,relaySuedAb)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use href="#shortArrow"/></svg>
</div>
<div>
<button onclick="sendLong (event, relaySuedAb,relaySuedAuf)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use transform="scale(1,-1) translate(0,-24)" href="#arrow"/></svg>
<button onclick="sendShort(event, relaySuedAb,relaySuedAuf)">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use transform="scale(1,-1) translate(0,-24)" href="#shortArrow"/></svg>
</div>
</div>


<script>
const shellyNord = "http://192.168.0.23"
const shellySued = "http://192.168.0.24"

const relaySuedAuf = shellySued + "/relay/0"
const relaySuedAb  = shellySued + "/relay/1"
const relayNordAuf = shellyNord + "/relay/0"
const relayNordAb  = shellyNord + "/relay/1"

function sendOff(relay)     { return fetch(relay + "?turn=off"); }
function sendOnLong(relay)  { return fetch(relay + "?turn=on&timer=2"); }
function sendOnShort(relay) { return fetch(relay + "?turn=on&timer=1"); }

var lastPromise = 0;

function init() {
  lastPromise = Promise.all([
    fetch(shellyNord + "/status"),
    fetch(shellySued + "/status")
  ]);
  lastPromise.catch(failureCallback);
}

function toggleBusyState(element) {
  var attr = element.getAttributeNode("busyCount");
  if (!attr) {
    attr = document.createAttribute("busyCount");
    attr.value = 0;
    element.setAttributeNode(attr);
  }
  element.classList.add("busy");
  attr.value = parseInt(attr.value) + 1;
  return ()=>{
    var num = parseInt(attr.value) - 1;
    attr.value = num;
    if (!num) {
      element.classList.remove("busy");
    }
  };
}


function sendLong(event, relay, opposite) {
  var toggle = toggleBusyState(event.currentTarget);
  navigator.vibrate(400);
  lastPromise = lastPromise
    .then(response => sendOff(opposite))
    .then(response => sendOff(relay))
    .then(response => sendOnLong(relay))
    .catch(failureCallback)
    .finally(toggle);
}

function sendShort(event, relay, opposite) {
  var toggle = toggleBusyState(event.currentTarget);
  navigator.vibrate(200);
  lastPromise = lastPromise
    .then(response => sendOff(opposite))
    .then(response => sendOff(relay))
    .then(response => Promise.all([sendOnShort(relay), createWait(200)]))
    .then(response => sendOff(relay))
    .catch(failureCallback)
    .finally(toggle);
}

function createWait(milliseconds) {
  return new Promise((resolve, reject) => {
    setTimeout(() => { resolve(); }, milliseconds);
  });
}

function failureCallback(err) {
  console.log(err);
}


(function() {
  document.querySelectorAll("button").forEach(
    (i)=>{ i.addEventListener("touchend" , onTouchend); });
})();

function onTouchend(event) {
  if (event.currentTarget.matches("button:active")) {
    event.currentTarget.click();
    event.preventDefault();
  }
}


</script>

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  style="display:none" viewBox="0 0 24 24">
  <path id="arrow" fill="gray" d="M5.23 10.64a1 1 0 0 0 1.41.13L11 7.14V19a1 1 0 0 0 2 0V7.14l4.36 3.63a1 1 0 1 0 1.28-1.54l-6-5l-.15-.09l-.13-.07a1 1 0 0 0-.72 0l-.13.07l-.15.09l-6 5a1 1 0 0 0-.13 1.41z"/>
  <path id="shortArrow" fill="gray" d="M18 15a1 1 0 0 1-.64-.23L12 10.29l-5.37 4.32a1 1 0 0 1-1.41-.15a1 1 0 0 1 .15-1.41l6-4.83a1 1 0 0 1 1.27 0l6 5a1 1 0 0 1 .13 1.41A1 1 0 0 1 18 15z"/>
</svg>

</body>
</html>
